Project : BaccaratPPRR88
Dưới đây là tóm tắt bối cảnh từ một chat cũ.
Hãy coi như bạn đã đọc toàn bộ lịch sử và code tương ứng, nhưng chỉ dùng thông tin trong tóm tắt này:

# Mục tiêu chính của project / bug
- Ổn định overlay theo dõi Baccarat/PP RR88: chặn telemetry, dịch TextMap, auto đóng popup, update username/balance, scan/render overlay multi-table với countdown/multi-card.
- Fix nghiệp vụ “Danh sách bàn”: JS gửi list lobby (~45 bàn), UI phải hiển thị đủ + đánh dấu bàn đã lưu config, không wipe selection khi refresh list rác.
- Đồng bộ ghim bàn một chiều: từ danh sách bàn được chọn → trạng thái ghim (không sync ngược).
- Dùng ID ổn định (id TileHeight-...) để định danh bàn; bỏ dùng name làm key.
- Kết quả BigRoad/ResultMap: đọc P/B/T chính xác từ SVG `<use href=#bigroad-...>` và thể hiện trên overlay.
- Thiết kế lại UI overlay theo yêu cầu (grid 38x6, countdown, status, thống kê, vùng người chơi/hòa/nhà cái).
- Lưu cấu hình từng bàn vào file mới `tablesettings.json`, không dùng chung `config.json`.

# Tech stack
- JavaScript thuần injected trong WebView2 (C# WPF host).
- C# WPF (MainWindow.xaml/.cs), WebView2 bridge JS/C#.
- JSON config UTF-8 (config.json + tablesettings.json).

# Các file / module quan trọng
- `js_home_v2.js`: overlay, lobby scan, sync pin, scroll, Dump Bacc3, ResultMap parsing, countdown, UI overlay.
- `MainWindow.xaml.cs`: load/save config, room list, selection, overlay spawn, pin sync, WebView2 bridge, task/logic.
- `MainWindow.xaml`: UI RoomList/Checkbox + bảng điều khiển.
- `tablesettings.json` (mới): lưu cấu hình theo bàn.
- `config.json`: global config (cắt lãi/lỗ tổng, các setting chung).
- `_rar_extract/MainWindow.xaml.cs` (backup lấy lại hàm bị thiếu) – đã exclude khỏi build.

# Logic chính đã thiết kế
## JS (js_home_v2.js)
- ID/Card root: `CARD_ID_ATTRS`, `resolveCardRoot(node)`, `getCardId(root)`, `findCardRootByName(id)`.
- Pin/overlay: `pinRooms(list)` → `setDesiredPinList` → `syncPinStates`, `ensurePinState`.
- Scroll: `scrollCardIntoView(roomId)`, `scrollLobbyTop()`.
- Dump: `collectBaccarat3Cards`, `extractBaccCardId`, `dumpBaccarat3Characters`.
- ResultMap/BIGROAD: đọc `<use href=#bigroad-...>` → map P/B/T; xử lý tie (T) dạng slash; chuỗi bệt >6 thì “đi ngang” theo quy tắc.
- Overlay grid 38x6 ô vuông, vòng tròn P/B chuẩn màu, T là gạch chéo + số khi >2.
- Countdown overlay góc phải bảng kết quả, vòng tròn đổi màu theo giây (>5 xanh, =5 vàng, <5 đỏ), số nhảy.
- Dòng thống kê (#total, P/B/T) + chip P/B/T, màu P dùng màu nền nút play.
- Thêm event focus table: `window.__abxTableOverlay` gửi `{overlay:'table', event:'focus', id}`.
- Thêm sync cut-profit/loss per table: `setCutValues`, `attachCutInputSync`, `postCutUpdate` (debounce, chỉ gửi khi đổi).

## C# (MainWindow.xaml.cs)
- Model mới: `TableSetting`, `TableSettingsFile`, `TableSettingsJsonOptions`.
- Fields: `_tableSettingsPath`, `_tableSettings`, `_tableSettingsWriteGate`, `_tableSettingsSaveCts`, `_activeTableId`, `_suppressTableSync`.
- Load/Save tablesettings UTF-8, debounce save, save khi close app.
- `GetOrCreateTableSetting`, `GetActiveTableSetting`, `ApplyTableSettingToUi`, `UpdateActiveTableSettingFromUi`.
- Khi click overlay → focus: `HandleTableFocusAsync` (highlight + sync dữ liệu bảng điều khiển).
- Cut-profit/loss per table: `PushTableCutValuesToOverlayAsync`, `SyncTableCutValuesForRoomsAsync`, `UpdateTableCutFromOverlay`.
- Global cut-profit/loss vẫn nằm `config.json` (dùng cho tổng thắng toàn hệ thống).
- `SyncStrategyFieldsToUI`, `LoadStakeCsvForCurrentMoneyStrategy`, `UpdateS7ResetOptionUI` dùng active table setting nếu có.
- WebMessageReceived xử lý `event: focus` và `event: cut`.
- `SpawnTableOverlayAsync` gọi `SyncTableCutValuesForRoomsAsync`.
- Đã restore các method bị mất: `RebuildStakeSeq`, `UpdateTooltips`, `NewWindowRequested`, `Enable/DisableCdpNetworkTapAsync`, `IsWebAlive`, `ClickXocDiaTitleAsync`, `HomeClickLoginAsync`, `HomeClickPlayAsync`, `VaoXocDia_Click`, `StopAutoLoginWatcher`, `ExecJsAsyncStr`, `OpenLiveItemImmediatelyAsync`, `LogPacket`, `IsInteresting`, `PreviewPayload`, v.v.

# Những lỗi đã gặp & nguyên nhân chính
- Danh sách bàn sai/ít: `_roomList` từng prefill từ `_selectedRooms` khi list rỗng → refresh rác ghi đè config.
- Ghim bàn khó xác định: tail thay đổi, click sai phần tử; cần nhận diện đúng icon ghim.
- Countdown/overlay mượt chưa ổn định; bệt >6 không hiển thị đúng.
- Vòng tròn méo ở một số overlay: do tính cell size phụ thuộc chiều cao/width không đồng nhất.
- Mất hàm trong `MainWindow.xaml.cs` → compile lỗi (RebuildStakeSeq, UpdateTooltips, …) do block bị xoá.
- Duplicate class/field/method errors: build trùng `_rar_extract\MainWindow.xaml.cs` + XAML.

# Các giải pháp đã thử / đang dùng
- Chặn list rác: check lobby + URL, giữ selection khi list trống.
- Pin 1 chiều: JS đọc actual pin nhưng không gửi ngược lên C#.
- ID ổn định dùng làm key (TileHeight-...), chỉ hiển thị name.
- ResultMap: đọc `<use href=#bigroad-...>` → parse P/B/T; T = slash + count; map P/B màu chuẩn.
- Grid 38x6: cell vuông theo chiều dài bảng; dư đều 2 bên; vòng tròn luôn tròn.
- Countdown overlay: hiển thị đè lên bảng kết quả, auto ẩn khi 0/null.
- Added tablesettings.json per table: lưu chiến lược, chuỗi, thế, quản lý vốn, chuỗi tiền, cắt lãi/lỗ table.
- Exclude `_rar_extract` khỏi build để tránh duplicate symbol errors.

# Việc còn dang dở / TODO
- Xác nhận compile OK sau khi exclude `_rar_extract` và restore methods.
- Hoàn thiện lưu tablesettings.json (debounce + close app đã có) và đồng bộ UI/overlay.
- Triển khai đầy đủ task đa bàn theo design: mỗi bàn Play tạo task riêng, sum tiền thắng toàn hệ thống, dừng toàn bộ khi global cut-profit/loss.
- Add “Bàn chơi” vào lịch sử cược (Bet History).
- Chuyển toàn bộ ký hiệu C/L → P/B trong mọi logic task.
- Kiểm tra các phần UI: cut lãi/lỗ input height sync, status font UTF-8 hiển thị chuẩn, thống kê dòng tổng ván align.
- Tối ưu đồng bộ hình vùng người chơi/hòa/nhà cái (nếu quay lại xử lý ảnh DOM).



Lưy ý : Kiểm tra và sửa lại code cho chính xác, chỉ sửa phần thay đổi của file
Đọc/ghi file bằng UTF-8, Encoding UTF8, viết code chuẩn UTF-8
Giao tiếp bằng tiếng việt

