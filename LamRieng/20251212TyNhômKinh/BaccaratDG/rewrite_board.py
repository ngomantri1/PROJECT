# -*- coding: utf-8 -*-
from pathlib import Path
path = Path('js_home_v2.js')
text = path.read_text('utf-8')
start = text.index('    async function runAutomationForBoard')
end = text.index('    async function runTemplateAutomationLoop')
new = "    async function runAutomationForBoard(board) {\n        const interval = typeof board.interval === 'number' ? board.interval : (automationConfig.templateBase.interval || 700);\n        const afterMatchDelay = typeof board.afterMatchDelay === 'number' ? board.afterMatchDelay : (automationConfig.templateBase.afterMatchDelay || 1500);\n        try {\n            while (S.templateAutomationRunning) {\n                await tryConfirmStage(board, afterMatchDelay);\n                const stage = board.end;\n                if (!stage) {\n                    updateAutomationStatus(`[${board.id}] Stage không hợp lệ`);\n                    await wait(interval);\n                    continue;\n                }\n                const sample = findTemplateByName(stage.name);\n                if (!sample) {\n                    updateAutomationStatus(`[${board.id}] Chưa có mẫu ${stage.name}`);\n                    await wait(interval);\n                    continue;\n                }\n                const targetRect = resolveStageRect(stage);\n                if (!targetRect) {\n                    updateAutomationStatus(`[${board.id}] Rect ${stage.name} không hợp lệ`);\n                    await wait(interval);\n                    continue;\n                }\n                let similarity = 0;\n                try {\n                    similarity = await compareTemplateToRect(sample, targetRect);\n                } catch (err) {\n                    updateAutomationStatus(`[${board.id}] Lỗi so sánh: ` + (err && err.message || err));\n                    await wait(interval);\n                    continue;\n                }\n                const threshold = typeof stage.threshold === 'number' ? stage.threshold : (sample.threshold || 0.8);\n                const pct = Math.round(similarity * 100);\n                if (!board.state.lock) {\n                    if (similarity < threshold) {\n                        const clickPoint = resolveStageClick(stage);\n                        if (clickPoint) {\n                            simulateClickAt(clickPoint.x, clickPoint.y);\n                            board.state.lock = true;\n                            updateAutomationStatus(`[${board.id}] ${stage.name} ${pct}% -> click`);\n                        } else {\n                            updateAutomationStatus(`[${board.id}] Click point ${stage.name} không hợp lệ`);\n                        }\n                        await wait(afterMatchDelay);\n                    } else {\n                        updateAutomationStatus(`[${board.id}] ${stage.name} ${pct}% -> mẫu đã hiện`);\n                        await wait(interval);\n                    }\n                } else {\n                    if (similarity >= threshold) {\n                        board.state.lock = false;\n                        updateAutomationStatus(`[${board.id}] ${stage.name} ${pct}% -> unlock`);\n                        await wait(afterMatchDelay);\n                    } else {\n                        updateAutomationStatus(`[${board.id}] ${stage.name} ${pct}% vẫn chưa thấy mẫu`);\n                        await wait(interval);\n                    }\n                }\n            }\n        } catch (err) {\n            updateAutomationStatus(`[${board.id}] Lỗi tự động: ` + (err && err.message || err));\n        }\n    }\n" 
text = text[:start] + new + text[end:]
path.write_text(text, encoding='utf-8')
